{"version":3,"sources":["skController.js"],"names":["db","require","fs","path","PDFDocument","exports","showSk","req","res","userId","session","user","id","userlogin","userRole","role","Pengajuan","findOne","where","pengajuan","SuratKeputusan","findAll","pengajuanId","include","model","sks","render","title","console","error","status","send","generateSK","params","flash","redirect","doc","filePath","join","__dirname","output","createWriteStream","pipe","fontSize","text","moveDown","nomor","tanggal","toDateString","end","on","download","err","unlinkSync"],"mappings":";;AAAA,IAAMA,EAAE,GAAGC,OAAO,CAAC,WAAD,CAAlB;;AACA,IAAMC,EAAE,GAAGD,OAAO,CAAC,IAAD,CAAlB;;AACA,IAAME,IAAI,GAAGF,OAAO,CAAC,MAAD,CAApB;;AACA,IAAMG,WAAW,GAAGH,OAAO,CAAC,QAAD,CAA3B;;AAEAI,OAAO,CAACC,MAAR,GAAiB,iBAAOC,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEPC,UAAAA,MAFO,GAEEF,GAAG,CAACG,OAAJ,CAAYC,IAAZ,CAAiBC,EAFnB,EAEuB;;AAC9BC,UAAAA,SAHO,GAGKN,GAAG,CAACG,OAAJ,CAAYC,IAHjB;AAIPG,UAAAA,QAJO,GAIID,SAAS,CAACE,IAJd,EAIoB;AACjC;;AALa;AAAA,0CAMWf,EAAE,CAACgB,SAAH,CAAaC,OAAb,CAAqB;AAC3CC,YAAAA,KAAK,EAAE;AAAET,cAAAA,MAAM,EAAEA;AAAV;AADoC,WAArB,CANX;;AAAA;AAMPU,UAAAA,SANO;AAAA;AAAA,0CASKnB,EAAE,CAACoB,cAAH,CAAkBC,OAAlB,CAA0B;AAC1CH,YAAAA,KAAK,EAAE;AAAEI,cAAAA,WAAW,EAAEH,SAAS,CAACP;AAAzB,aADmC;AAE1CW,YAAAA,OAAO,EAAE,CAAC;AAACC,cAAAA,KAAK,EAAExB,EAAE,CAACgB;AAAX,aAAD;AAFiC,WAA1B,CATL;;AAAA;AASPS,UAAAA,GATO;AAcbjB,UAAAA,GAAG,CAACkB,MAAJ,CAAW,qBAAX,EAAkC;AAC/BD,YAAAA,GAAG,EAAHA,GAD+B;AAE/BE,YAAAA,KAAK,EAAE,iBAFwB;AAG/Bb,YAAAA,QAAQ,EAARA;AAH+B,WAAlC;AAda;AAAA;;AAAA;AAAA;AAAA;AAoBbc,UAAAA,OAAO,CAACC,KAAR,CAAc,iCAAd;AACArB,UAAAA,GAAG,CAACsB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,uBAArB;;AArBa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAjB;;AAyBA1B,OAAO,CAAC2B,UAAR,GAAqB,kBAAOzB,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEXc,UAAAA,WAFW,GAEGf,GAAG,CAAC0B,MAAJ,CAAWrB,EAFd,EAIjB;;AAJiB;AAAA,0CAKOZ,EAAE,CAACgB,SAAH,CAAaC,OAAb,CAAqB;AAC3CC,YAAAA,KAAK,EAAE;AAAEN,cAAAA,EAAE,EAAEU;AAAN,aADoC;AAE3CC,YAAAA,OAAO,EAAE,CAACvB,EAAE,CAACoB,cAAJ,CAFkC,CAEd;;AAFc,WAArB,CALP;;AAAA;AAKXD,UAAAA,SALW;;AAAA,cAUZA,SAVY;AAAA;AAAA;AAAA;;AAWfZ,UAAAA,GAAG,CAAC2B,KAAJ,CAAU,OAAV,EAAmB,4BAAnB;AAXe,4CAYR1B,GAAG,CAAC2B,QAAJ,CAAa,kBAAb,CAZQ;;AAAA;AAejB;AACMC,UAAAA,GAhBW,GAgBL,IAAIhC,WAAJ,EAhBK,EAkBjB;;AACMiC,UAAAA,QAnBW,GAmBAlC,IAAI,CAACmC,IAAL,CAAUC,SAAV,EAAqB,IAArB,EAA2B,KAA3B,eAAwCjB,WAAxC,UAnBA;AAoBXkB,UAAAA,MApBW,GAoBFtC,EAAE,CAACuC,iBAAH,CAAqBJ,QAArB,CApBE;AAqBjBD,UAAAA,GAAG,CAACM,IAAJ,CAASF,MAAT,EArBiB,CAuBjB;;AACAJ,UAAAA,GAAG,CAACO,QAAJ,CAAa,EAAb;AACAP,UAAAA,GAAG,CAACQ,IAAJ;AACAR,UAAAA,GAAG,CAACS,QAAJ,GA1BiB,CA4BjB;;AACAT,UAAAA,GAAG,CAACQ,IAAJ,wBAAyBzB,SAAS,CAACC,cAAV,CAAyB0B,KAAlD;AACAV,UAAAA,GAAG,CAACQ,IAAJ,oBAAqBzB,SAAS,CAACC,cAAV,CAAyB2B,OAAzB,CAAiCC,YAAjC,EAArB,GA9BiB,CA+BjB;AAEA;;AACAZ,UAAAA,GAAG,CAACa,GAAJ,GAlCiB,CAoCjB;;AACAT,UAAAA,MAAM,CAACU,EAAP,CAAU,QAAV,EAAoB,YAAM;AACxB1C,YAAAA,GAAG,CAAC2C,QAAJ,CAAad,QAAb,eAA6Bf,WAA7B,WAAgD,UAAC8B,GAAD,EAAS;AACvD,kBAAIA,GAAJ,EAAS;AACPxB,gBAAAA,OAAO,CAACC,KAAR,CAAc,qBAAd,EAAqCuB,GAArC;AACA5C,gBAAAA,GAAG,CAACsB,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,0BAArB;AACD,eAJsD,CAKvD;;;AACA7B,cAAAA,EAAE,CAACmD,UAAH,CAAchB,QAAd;AACD,aAPD;AAQD,WATD;AArCiB;AAAA;;AAAA;AAAA;AAAA;AAiDjBT,UAAAA,OAAO,CAACC,KAAR,CAAc,sBAAd;AACAtB,UAAAA,GAAG,CAAC2B,KAAJ,CAAU,OAAV,EAAmB,uBAAnB;AACA1B,UAAAA,GAAG,CAAC2B,QAAJ,CAAa,kBAAb;;AAnDiB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAArB","sourcesContent":["const db = require('../models');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst PDFDocument = require('pdfkit');\r\n\r\nexports.showSk = async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id; // Ambil userId dari pengguna yang sedang login\r\n    const userlogin = req.session.user;\r\n    const userRole = userlogin.role; // Mendapatkan role user\r\n    // Ambil pengajuan yang terhubung dengan userId\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { userId: userId }\r\n    });\r\n    const sks = await db.SuratKeputusan.findAll({\r\n      where: { pengajuanId: pengajuan.id },\r\n      include: [{model: db.Pengajuan}]\r\n    });\r\n\r\n    res.render('user/suratkeputusan', {\r\n       sks,\r\n       title: 'Surat Keputusan',\r\n       userRole\r\n       });\r\n  } catch (error) {\r\n    console.error('Error fetching surat keputusan:', error);\r\n    res.status(500).send('Internal Server Error');\r\n  }\r\n};\r\n\r\nexports.generateSK = async (req, res) => {\r\n  try {\r\n    const pengajuanId = req.params.id;\r\n    \r\n    // Fetch pengajuan details\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { id: pengajuanId },\r\n      include: [db.SuratKeputusan] // Include SK if needed\r\n    });\r\n\r\n    if (!pengajuan) {\r\n      req.flash('error', 'Pengajuan tidak ditemukan.');\r\n      return res.redirect('/daftarPengajuan');\r\n    }\r\n\r\n    // Create a new PDF document\r\n    const doc = new PDFDocument();\r\n\r\n    // Pipe the PDF into a writable stream which then gets piped to response\r\n    const filePath = path.join(__dirname, '..', 'tmp', `sk_${pengajuanId}.pdf`);\r\n    const output = fs.createWriteStream(filePath);\r\n    doc.pipe(output);\r\n\r\n    // Build the content of the PDF dynamically based on pengajuan data\r\n    doc.fontSize(12);\r\n    doc.text(`Surat Keputusan`);\r\n    doc.moveDown();\r\n\r\n    // Insert content dynamically\r\n    doc.text(`Nomor Surat: ${pengajuan.SuratKeputusan.nomor}`);\r\n    doc.text(`Tanggal: ${pengajuan.SuratKeputusan.tanggal.toDateString()}`);\r\n    // Add more content as needed\r\n\r\n    // Finalize the PDF and close the stream\r\n    doc.end();\r\n\r\n    // Send file as response for download\r\n    output.on('finish', () => {\r\n      res.download(filePath, `SK_${pengajuanId}.pdf`, (err) => {\r\n        if (err) {\r\n          console.error('Error sending file:', err);\r\n          res.status(500).send('Failed to download file.');\r\n        }\r\n        // Delete the temporary file after download\r\n        fs.unlinkSync(filePath);\r\n      });\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error generating SK:', error);\r\n    req.flash('error', 'Failed to generate SK');\r\n    res.redirect('/daftarPengajuan');\r\n  }\r\n};"],"file":"skController.dev.js"}