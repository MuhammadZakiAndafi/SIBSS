{"version":3,"sources":["skController.js"],"names":["db","require","fs","path","PDFDocument","exports","showSk","req","res","userId","session","user","id","userlogin","userRole","role","Pengajuan","findOne","where","pengajuan","SuratKeputusan","findAll","pengajuanId","include","model","sks","render","title","console","error","status","send","generateSK","params","flash","redirect","doc","outputDir","join","__dirname","existsSync","mkdirSync","filePath","output","createWriteStream","pipe","fontSize","text","moveDown","nomor","tanggal","toDateString","fontWeight","name","nim","end","create","Date","keterangan","lampiran"],"mappings":"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","sourcesContent":["const db = require('../models');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst PDFDocument = require('pdfkit');\r\n\r\nexports.showSk = async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id; // Ambil userId dari pengguna yang sedang login\r\n    const userlogin = req.session.user;\r\n    const userRole = userlogin.role; // Mendapatkan role user\r\n    // Ambil pengajuan yang terhubung dengan userId\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { userId: userId }\r\n    });\r\n    const sks = await db.SuratKeputusan.findAll({\r\n      where: { pengajuanId: pengajuan.id },\r\n      include: [{model: db.Pengajuan}]\r\n    });\r\n\r\n    res.render('user/suratkeputusan', {\r\n       sks,\r\n       title: 'Surat Keputusan',\r\n       userRole\r\n       });\r\n  } catch (error) {\r\n    console.error('Error fetching surat keputusan:', error);\r\n    res.status(500).send('Internal Server Error');\r\n  }\r\n};\r\n\r\nexports.generateSK = async (req, res) => {\r\n  try {\r\n    const pengajuanId = req.params.id;\r\n    \r\n    // Fetch pengajuan details\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { id: pengajuanId },\r\n      include: [db.SuratKeputusan] // Include SK if needed\r\n    });\r\n\r\n    if (!pengajuan) {\r\n      req.flash('error', 'Pengajuan tidak ditemukan.');\r\n      return res.redirect('/daftarPengajuan');\r\n    }\r\n\r\n    // Create a new PDF document\r\n    const doc = new PDFDocument();\r\n\r\n    // Set up the output file path and create the directory if it doesn't exist\r\n    const outputDir = path.join(__dirname, '..', 'output');\r\n    if (!fs.existsSync(outputDir)) {\r\n      fs.mkdirSync(outputDir);\r\n    }\r\n    const filePath = path.join(outputDir, `sk_${pengajuanId}.pdf`);\r\n\r\n    // Pipe the PDF into a writable stream\r\n    const output = fs.createWriteStream(filePath);\r\n    doc.pipe(output);\r\n\r\n    // Build the content of the PDF dynamically based on pengajuan data\r\n    doc.fontSize(12);\r\n    doc.text(`Surat Keputusan`);\r\n    doc.moveDown();\r\n\r\n    // Insert content dynamically\r\n    if (pengajuan.SuratKeputusan) {\r\n      doc.text(`Nomor Surat: ${pengajuan.SuratKeputusan.nomor}`);\r\n      doc.text(`Tanggal: ${pengajuan.SuratKeputusan.tanggal.toDateString()}`);\r\n    } else {\r\n      doc.text(`Nomor Surat: -`);\r\n      doc.text(`Tanggal: -`);\r\n          // Add title\r\n      doc.text('KEPUTUSAN REKTOR UNIVERSITAS ANDALAS',{ fontSize: 24, fontWeight: 'bold' });\r\n      doc.text('Nomor 1084/XIV/R/KPT/2024');\r\n\r\n      // Add subtitle\r\n      doc.text('BERHENTI STUDI SEMENTARA MAHASISWA PROGRAM SARJANA UNIVERSITAS ANDALAS PADA SEMESTER GENAP TAHUN AKADEMIK 2023/2024', { fontSize: 18, fontWeight: 'bold' });\r\n      doc.text('REKTOR UNIVERSITAS ANDALAS,',{ fontSize: 18, fontWeight: 'bold' });\r\n\r\n      // Add content\r\n      doc.text('Membaca:', { fontSize: 14, fontWeight: 'bold' });\r\n      doc.text(`Surat Permohonan Berhenti Studi Sementara mahasiswa Program Sarjana Universitas Andalas atas nama ${pengajuan.name} NIM. ${pengajuan.nim} dan kawan-kawan yang telah disetujui Dekan/Direktur Fakultas/Program di lingkungan Universitas Andalas`);\r\n\r\n      doc.text('Menimbang:', { fontSize: 14, fontWeight: 'bold' });\r\n      doc.text(`a. bahwa berdasarkan Peraturan Rektor Nomor 3 Tahun 2016 tentang peraturan akademik Universitas Andalas, kepada ${pengajuan.name} NIM. ${pengajuan.nim} dan kawan-kawan dapat diberikan izin untuk Berhenti Studi Sementara;`);\r\n      doc.text('b. bahwa untuk pelaksanaan hal tersebut pada butir a di atas perlu ditetapkan dengan Keputusan Rektor.');\r\n\r\n      doc.text('Mengingat:', { fontSize: 14, fontWeight: 'bold' });\r\n      doc.text('1. Undang-Undang Nomor 12 Tahun 2012 tentang Pendidikan Tinggi (Lembaran Negara Republik Indonesia Tahun 2012 Nomor 158, Tambahan Lembaran Negara Republik Indonesia Nomor 5336);');\r\n      doc.text('2. Peraturan Pemerintah Nomor 4 Tahun 2014 tentang Penyelenggaraan Pendidikan Tinggi dan Pengelolaan Perguruan Tinggi (Lembaran Negara Republik Indonesia Tahun 2014 Nomor 14, Tambahan Lembaran Negara Republik Indonesia Nomor 5500);');\r\n      doc.text('3. Peraturan Presiden Republik Indonesia Nomor 8 tahun 2012 tentang Kerangka Kualifikasi Nasional Indonesia (KKNI) (Lembaran Negara Republik Indonesia Tahun 2012 Nomor 24);');\r\n      doc.text('4. Peraturan Menteri Pendidikan dan Kebudayaan Republik Indonesia Nomor 25 Tahun 2012 tentang Organisasi dan Tata Kerja Universitas Andalas (Berita Negara Republik Indonesia Tahun 2012 Nomor 434);');\r\n      doc.text('5. Peraturan Menteri Pendidikan dan Kebudayaan Republik Indonesia Nomor 47 Tahun 2013 tentang Statuta Universitas Andalas (Berita Negara Republik Indonesia Tahun 2013 Nomor 596);');\r\n\r\n    }\r\n    // Add more content as needed\r\n\r\n    // Finalize the PDF and close the stream\r\n    doc.end();\r\n\r\n    // Save the SK to database\r\n    if (!pengajuan.SuratKeputusan) {\r\n      await db.SuratKeputusan.create({\r\n        pengajuanId: pengajuanId,\r\n        nomor: '',\r\n        tanggal: new Date(),\r\n        keterangan: '',\r\n        lampiran: '',\r\n        // Add more fields as needed\r\n      });\r\n    }\r\n\r\n    // Send a success response\r\n    res.status(201).send(`SK generated successfully and saved to ${filePath}`);\r\n\r\n  } catch (error) {\r\n    console.error('Error generating SK:', error);\r\n    req.flash('error', 'Failed to generate SK');\r\n    res.redirect('/daftarPengajuan');\r\n  }\r\n};"],"file":"skController.dev.js"}