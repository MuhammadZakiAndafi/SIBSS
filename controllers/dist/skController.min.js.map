{"version":3,"sources":["skController.js"],"names":["db","require","fs","path","PDFDocument","exports","showSk","req","res","userId","userlogin","userRole","pengajuan","sks","regeneratorRuntime","async","_context","prev","next","session","user","id","role","awrap","Pengajuan","findOne","where","sent","SuratKeputusan","findAll","pengajuanId","include","model","title","t0","send","stop","generateSK","doc","filePath","output","_context2","params","flash","abrupt","redirect","join","__dirname","concat","createWriteStream","pipe","fontSize","console","text","nomor","tanggal","toDateString","end","on","download","err","error","status","unlinkSync"],"mappings":"aAAA,IAAMA,GAAKC,QAAQ,aACbC,GAAKD,QAAQ,MADXE,KAAGF,QAAQ,QAGbG,YAAcH,QAAQ,UAE5BI,QAAQC,OAAS,SAAOC,EAAKC,GAAZ,IAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,OAAAC,mBAAAC,MAAA,SAAAC,GAAA,OAAA,OAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,OAAAF,EAAAC,KAAA,EAEPR,EAASF,EAAIY,QAAQC,KAAKC,GAJ9BjB,EAAcH,EAAQkB,QAADC,KAMjBT,EAAWD,EAAUY,KAJdN,EAAAE,KAAA,EAAAJ,mBAAAS,MAAAvB,GAAAwB,UAAAC,QAAA,CAAAC,MAAA,CAAAjB,OAAAA,MAAA,KAAA,EAAA,OAAAG,EAAAI,EAAAW,KAAAX,EAAAE,KAAA,EAAAJ,mBAAAS,MAAAvB,GAAA4B,eAAAC,QAAA,CAAAH,MAAA,CAAAI,YAAAlB,EAAAS,IAAAU,QAAA,CAAA,CAAAC,MAAAhC,GAAAwB,eAAA,KAAA,EAAAX,EAAAG,EAAAW,KAGPjB,EAAAA,OAAAA,sBAHO,CAIPC,IAAAA,EACNsB,MAAA,kBAYGtB,SAAAA,IAjBUK,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAC,KAAA,GAAAD,EAAAkB,GAAAlB,EAAA,MAAA,GAOXU,QAAAA,MAAK,kCAALA,EAAAA,IAASjB,EAAAA,OAAAA,KAAM0B,KAAE1B,yBAPN,KAAA,GAAA,IAAA,MAAA,OAAAO,EAAAoB,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,OAAA/B,QAAAgC,WAAA,SAAA9B,EAAAC,GAAA,IAAAsB,EAAAlB,EAAA0B,EAAAC,EAAAC,EAAA,OAAA1B,mBAAAC,MAAA,SAAA0B,GAAA,OAAA,OAAAA,EAAAxB,KAAAwB,EAAAvB,MAAA,KAAA,EAAA,OAAAuB,EAAAxB,KAAA,EAAAa,EAAAvB,EAAAmC,OAAArB,GAAAoB,EAAAvB,KAAA,EAAAJ,mBAAAS,MAUWX,GAAAA,UAAUS,QAAAA,CAAzBK,MADmC,CAAAL,GAAAS,GAE1CC,QAAAA,CAAAA,GAAOH,mBAXI,KAAA,EAAA,GAUFE,EAVEW,EAAAd,KAAA,CAAAc,EAAAvB,KAAA,EAAA,MAAA,OAoCXX,EAAIoC,MAAM,QAAS,8BApCRF,EAAAG,OAAA,SAAApC,EAAAqC,SAAA,qBAAA,KAAA,EAgBVZ,EAAAA,IAAO7B,YAhBGmC,EAAApC,KAAA2C,KAAAC,UAAA,KAAA,MAAA,MAAAC,OAAAlB,EAAA,SAAAU,EAAAtC,GAAA+C,kBAAAV,GA8CbD,EAAIY,KAAKV,GA9CIF,EAAAa,SAAA,IAoBbC,EAAAA,KAAAA,mBACA5C,EAAAA,WArBa8B,EAAAe,KAAA,gBAAAL,OAAApC,EAAAgB,eAAA0B,QAAAhB,EAAAe,KAAA,YAAAL,OAAApC,EAAAgB,eAAA2B,QAAAC,iBAAjBlB,EAAAmB,MAyBqBjB,EAAAkB,GAAA,SAAA,WAAAlD,EAAAmD,SAAApB,EAAA,MAAAS,OAAAlB,EAAA,QAAA,SAAA8B,GAAAA,IAAAR,QAAAS,MAAA,sBAAAD,GAAApD,EAAAsD,OAAA,KAAA3B,KAAA,6BA4CbjC,GAAG6D,WAAWxB,OArELE,EAAAvB,KAAA,GAAA,MAAA,KAAA,GAAAuB,EAAAxB,KAAA,GAAAwB,EAAAP,GAAAO,EAAA,MAAA,GA+BJW,QAAAS,MADoC,uBACpCpB,EAAAP,IACPH,EAAAA,MAAAA,QAAU/B,yBA4CZQ,EAAIqC,SAAS,oBA5EA,KAAA,GAAA,IAAA,MAAA,OAAAJ,EAAAL,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA","file":"skController.min.js","sourcesContent":["const db = require('../models');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst PDFDocument = require('pdfkit');\r\n\r\nexports.showSk = async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id; // Ambil userId dari pengguna yang sedang login\r\n    const userlogin = req.session.user;\r\n    const userRole = userlogin.role; // Mendapatkan role user\r\n    // Ambil pengajuan yang terhubung dengan userId\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { userId: userId }\r\n    });\r\n    const sks = await db.SuratKeputusan.findAll({\r\n      where: { pengajuanId: pengajuan.id },\r\n      include: [{model: db.Pengajuan}]\r\n    });\r\n\r\n    res.render('user/suratkeputusan', {\r\n       sks,\r\n       title: 'Surat Keputusan',\r\n       userRole\r\n       });\r\n  } catch (error) {\r\n    console.error('Error fetching surat keputusan:', error);\r\n    res.status(500).send('Internal Server Error');\r\n  }\r\n};\r\n\r\nexports.generateSK = async (req, res) => {\r\n  try {\r\n    const pengajuanId = req.params.id;\r\n    \r\n    // Fetch pengajuan details\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { id: pengajuanId },\r\n      include: [db.SuratKeputusan] // Include SK if needed\r\n    });\r\n\r\n    if (!pengajuan) {\r\n      req.flash('error', 'Pengajuan tidak ditemukan.');\r\n      return res.redirect('/daftarPengajuan');\r\n    }\r\n\r\n    // Create a new PDF document\r\n    const doc = new PDFDocument();\r\n\r\n    // Pipe the PDF into a writable stream which then gets piped to response\r\n    const filePath = path.join(__dirname, '..', 'tmp', `sk_${pengajuanId}.pdf`);\r\n    const output = fs.createWriteStream(filePath);\r\n    doc.pipe(output);\r\n\r\n    // Build the content of the PDF dynamically based on pengajuan data\r\n    doc.fontSize(12);\r\n    doc.text(`Surat Keputusan`);\r\n    doc.moveDown();\r\n\r\n    // Insert content dynamically\r\n    doc.text(`Nomor Surat: ${pengajuan.SuratKeputusan.nomor}`);\r\n    doc.text(`Tanggal: ${pengajuan.SuratKeputusan.tanggal.toDateString()}`);\r\n    // Add more content as needed\r\n\r\n    // Finalize the PDF and close the stream\r\n    doc.end();\r\n\r\n    // Send file as response for download\r\n    output.on('finish', () => {\r\n      res.download(filePath, `SK_${pengajuanId}.pdf`, (err) => {\r\n        if (err) {\r\n          console.error('Error sending file:', err);\r\n          res.status(500).send('Failed to download file.');\r\n        }\r\n        // Delete the temporary file after download\r\n        fs.unlinkSync(filePath);\r\n      });\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('Error generating SK:', error);\r\n    req.flash('error', 'Failed to generate SK');\r\n    res.redirect('/daftarPengajuan');\r\n  }\r\n};"]}