{"version":3,"sources":["skController.js"],"names":["db","require","fs","path","PDFDocument","exports","showSk","req","res","userId","userlogin","userRole","pengajuan","sks","regeneratorRuntime","async","_context","prev","next","session","user","id","role","awrap","Pengajuan","findOne","where","sent","SuratKeputusan","findAll","pengajuanId","include","model","title","t0","send","stop","generateSK","doc","outputDir","filePath","output","_context2","params","flash","abrupt","redirect","join","__dirname","existsSync","mkdirSync","concat","status","createWriteStream","pipe","fontSize","text","moveDown","nomor","tanggal","toDateString","fontWeight","name","nim","end","keterangan"],"mappings":"aAAA,IAAMA,GAAKC,QAAQ,aACbC,GAAKD,QAAQ,MADXE,KAAGF,QAAQ,QAGbG,YAAcH,QAAQ,UAE5BI,QAAQC,OAAS,SAAOC,EAAKC,GAAZ,IAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,OAAAC,mBAAAC,MAAA,SAAAC,GAAA,OAAA,OAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,OAAAF,EAAAC,KAAA,EAEPR,EAASF,EAAIY,QAAQC,KAAKC,GAJ9BjB,EAAcH,EAAQkB,QAADC,KAMjBT,EAAWD,EAAUY,KAJdN,EAAAE,KAAA,EAAAJ,mBAAAS,MAAAvB,GAAAwB,UAAAC,QAAA,CAAAC,MAAA,CAAAjB,OAAAA,MAAA,KAAA,EAAA,OAAAG,EAAAI,EAAAW,KAAAX,EAAAE,KAAA,EAAAJ,mBAAAS,MAAAvB,GAAA4B,eAAAC,QAAA,CAAAH,MAAA,CAAAI,YAAAlB,EAAAS,IAAAU,QAAA,CAAA,CAAAC,MAAAhC,GAAAwB,eAAA,KAAA,EAAAX,EAAAG,EAAAW,KAGPjB,EAAAA,OAAAA,sBAHO,CAIPC,IAAAA,EACNsB,MAAA,kBAYGtB,SAAAA,IAjBUK,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAC,KAAA,GAAAD,EAAAkB,GAAAlB,EAAA,MAAA,GAOXU,QAAAA,MAAK,kCAALA,EAAAA,IAASjB,EAAAA,OAAAA,KAAM0B,KAAE1B,yBAPN,KAAA,GAAA,IAAA,MAAA,OAAAO,EAAAoB,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,OAAA/B,QAAAgC,WAAA,SAAA9B,EAAAC,GAAA,IAAAsB,EAAAlB,EAAA0B,EAAAC,EAAAC,EAAAC,EAAA,OAAA3B,mBAAAC,MAAA,SAAA2B,GAAA,OAAA,OAAAA,EAAAzB,KAAAyB,EAAAxB,MAAA,KAAA,EAAA,OAAAwB,EAAAzB,KAAA,EAAAa,EAAAvB,EAAAoC,OAAAtB,GAAAqB,EAAAxB,KAAA,EAAAJ,mBAAAS,MAUWX,GAAAA,UAAUS,QAAAA,CAAzBK,MADmC,CAAAL,GAAAS,GAE1CC,QAAAA,CAAAA,GAAOH,mBAXI,KAAA,EAAA,GAUFE,EAVEY,EAAAf,KAAA,CAAAe,EAAAxB,KAAA,EAAA,MAAA,OAoCXX,EAAIqC,MAAM,QAAS,8BApCRF,EAAAG,OAAA,SAAArC,EAAAsC,SAAA,qBAAA,KAAA,EAAA,GAgBVb,EAAAA,IAAO7B,YAhBGmC,EAAApC,KAAA4C,KAAAC,UAAA,KAAA,UAAA9C,GAAA+C,WAAAV,IA8CXrC,GAAGgD,UAAUX,GA9CFC,EAAArC,KAAA4C,KAAAR,EAAA,MAAAY,OAAArB,EAAA,SAqBbtB,EAAI4C,GAAOC,kBAAUb,GA+BrBF,EAAIgB,KAAKb,GApDIH,EAAAiB,SAAA,IAAAjB,EAAAkB,KAAA,mBAAAlB,EAAAmB,WA4DT7C,EAAUgB,gBAnClBvB,EAAQgC,KAARhC,gBAAAA,OAAqBO,EAAOL,eAAPmD,QAAApB,EAAAkB,KAAA,YAAAL,OAAAvC,EAAAgB,eAAA+B,QAAAC,mBAAAtB,EAAAkB,KAAA,kBAAAlB,EAAAkB,KAAA,cAAAlB,EAAAkB,KAAA,uCAAA,CAAAD,SAAA,GAAAM,WAAA,SAEX/B,EAAAA,KAAAA,6BAFWQ,EAAAkB,KAAA,sHAK4B,CAAAD,SAAA,GAAAM,WAAA,SAC3CnC,EAAAA,KAAAA,8BAAO,CAAA6B,SAAA,GAAAM,WAAA,SACP9B,EAAAA,KAAAA,WAAaH,CAAAA,SAAJ,GAAoBiC,WAAA,SA4C7BvB,EAAIkB,KAAJ,qGAAAL,OAA8GvC,EAAUkD,KAAxH,UAAAX,OAAqIvC,EAAUmD,IAA/I,4GAEAzB,EAAIkB,KAAK,aAAc,CAAED,SAAU,GAAIM,WAAY,SArDpCvB,EAAAkB,KAAA,mHAAAL,OAAAvC,EAAAkD,KAAA,UAAAX,OAAAvC,EAAAmD,IAAA,0EAKXnD,EAAAA,KAAAA,0GALW0B,EAAAkB,KAUZ5C,aAVY,CAAA2C,SAAA,GAAAM,WAAA,SAAAvB,EAAAkB,KAAA,qLAAAlB,EAAAkB,KAAA,2OAAAlB,EAAAkB,KAAA,gLA6DflB,EAAIkB,KAAK,wMAlDTjD,EAAAA,KAAIqC,uLAyDNN,EAAI0B,MAhDJpD,EAAQqC,eA7CK,CAAAP,EAAAxB,KAAA,GAAA,MAAA,OAAAwB,EAAAxB,KAAA,GAAAJ,mBAAAS,MA8CXrB,GAAGgD,eAAUX,OAAb,CACDT,YAAAA,EAoDG4B,MAAO,GAnDLlB,QAAAA,IAAWrC,KAqDb8D,WAAY,GAlDVxB,SA1BW,MAzBJ,KAAA,GA4GbjC,EAAI4C,OAAO,KAAKjB,KAAhB,0CAAAgB,OAA+DX,IA5GlDE,EAAAxB,KAAA,GAAA,MAAA,KAAA,GAAAwB,EAAAzB,KAAA,GAAAyB,EAAAR,GAAAQ,EAAA,MAAA,GA8DXJ,QAAAA,MAAIkB,uBAAJlB,EAAAA,IACD/B,EAAAqC,MAHD,QAGO,yBACLN,EAAAA,SAAIkB,oBAhEO,KAAA,GAAA,IAAA,MAAA,OAAAd,EAAAN,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA","file":"skController.min.js","sourcesContent":["const db = require('../models');\r\nconst fs = require('fs');\r\nconst path = require('path');\r\nconst PDFDocument = require('pdfkit');\r\n\r\nexports.showSk = async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id; // Ambil userId dari pengguna yang sedang login\r\n    const userlogin = req.session.user;\r\n    const userRole = userlogin.role; // Mendapatkan role user\r\n    // Ambil pengajuan yang terhubung dengan userId\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { userId: userId }\r\n    });\r\n    const sks = await db.SuratKeputusan.findAll({\r\n      where: { pengajuanId: pengajuan.id },\r\n      include: [{model: db.Pengajuan}]\r\n    });\r\n\r\n    res.render('user/suratkeputusan', {\r\n       sks,\r\n       title: 'Surat Keputusan',\r\n       userRole\r\n       });\r\n  } catch (error) {\r\n    console.error('Error fetching surat keputusan:', error);\r\n    res.status(500).send('Internal Server Error');\r\n  }\r\n};\r\n\r\nexports.generateSK = async (req, res) => {\r\n  try {\r\n    const pengajuanId = req.params.id;\r\n    \r\n    // Fetch pengajuan details\r\n    const pengajuan = await db.Pengajuan.findOne({\r\n      where: { id: pengajuanId },\r\n      include: [db.SuratKeputusan] // Include SK if needed\r\n    });\r\n\r\n    if (!pengajuan) {\r\n      req.flash('error', 'Pengajuan tidak ditemukan.');\r\n      return res.redirect('/daftarPengajuan');\r\n    }\r\n\r\n    // Create a new PDF document\r\n    const doc = new PDFDocument();\r\n\r\n    // Set up the output file path and create the directory if it doesn't exist\r\n    const outputDir = path.join(__dirname, '..', 'output');\r\n    if (!fs.existsSync(outputDir)) {\r\n      fs.mkdirSync(outputDir);\r\n    }\r\n    const filePath = path.join(outputDir, `sk_${pengajuanId}.pdf`);\r\n\r\n    // Pipe the PDF into a writable stream\r\n    const output = fs.createWriteStream(filePath);\r\n    doc.pipe(output);\r\n\r\n    // Build the content of the PDF dynamically based on pengajuan data\r\n    doc.fontSize(12);\r\n    doc.text(`Surat Keputusan`);\r\n    doc.moveDown();\r\n\r\n    // Insert content dynamically\r\n    if (pengajuan.SuratKeputusan) {\r\n      doc.text(`Nomor Surat: ${pengajuan.SuratKeputusan.nomor}`);\r\n      doc.text(`Tanggal: ${pengajuan.SuratKeputusan.tanggal.toDateString()}`);\r\n    } else {\r\n      doc.text(`Nomor Surat: -`);\r\n      doc.text(`Tanggal: -`);\r\n          // Add title\r\n      doc.text('KEPUTUSAN REKTOR UNIVERSITAS ANDALAS',{ fontSize: 24, fontWeight: 'bold' });\r\n      doc.text('Nomor 1084/XIV/R/KPT/2024');\r\n\r\n      // Add subtitle\r\n      doc.text('BERHENTI STUDI SEMENTARA MAHASISWA PROGRAM SARJANA UNIVERSITAS ANDALAS PADA SEMESTER GENAP TAHUN AKADEMIK 2023/2024', { fontSize: 18, fontWeight: 'bold' });\r\n      doc.text('REKTOR UNIVERSITAS ANDALAS,',{ fontSize: 18, fontWeight: 'bold' });\r\n\r\n      // Add content\r\n      doc.text('Membaca:', { fontSize: 14, fontWeight: 'bold' });\r\n      doc.text(`Surat Permohonan Berhenti Studi Sementara mahasiswa Program Sarjana Universitas Andalas atas nama ${pengajuan.name} NIM. ${pengajuan.nim} dan kawan-kawan yang telah disetujui Dekan/Direktur Fakultas/Program di lingkungan Universitas Andalas`);\r\n\r\n      doc.text('Menimbang:', { fontSize: 14, fontWeight: 'bold' });\r\n      doc.text(`a. bahwa berdasarkan Peraturan Rektor Nomor 3 Tahun 2016 tentang peraturan akademik Universitas Andalas, kepada ${pengajuan.name} NIM. ${pengajuan.nim} dan kawan-kawan dapat diberikan izin untuk Berhenti Studi Sementara;`);\r\n      doc.text('b. bahwa untuk pelaksanaan hal tersebut pada butir a di atas perlu ditetapkan dengan Keputusan Rektor.');\r\n\r\n      doc.text('Mengingat:', { fontSize: 14, fontWeight: 'bold' });\r\n      doc.text('1. Undang-Undang Nomor 12 Tahun 2012 tentang Pendidikan Tinggi (Lembaran Negara Republik Indonesia Tahun 2012 Nomor 158, Tambahan Lembaran Negara Republik Indonesia Nomor 5336);');\r\n      doc.text('2. Peraturan Pemerintah Nomor 4 Tahun 2014 tentang Penyelenggaraan Pendidikan Tinggi dan Pengelolaan Perguruan Tinggi (Lembaran Negara Republik Indonesia Tahun 2014 Nomor 14, Tambahan Lembaran Negara Republik Indonesia Nomor 5500);');\r\n      doc.text('3. Peraturan Presiden Republik Indonesia Nomor 8 tahun 2012 tentang Kerangka Kualifikasi Nasional Indonesia (KKNI) (Lembaran Negara Republik Indonesia Tahun 2012 Nomor 24);');\r\n      doc.text('4. Peraturan Menteri Pendidikan dan Kebudayaan Republik Indonesia Nomor 25 Tahun 2012 tentang Organisasi dan Tata Kerja Universitas Andalas (Berita Negara Republik Indonesia Tahun 2012 Nomor 434);');\r\n      doc.text('5. Peraturan Menteri Pendidikan dan Kebudayaan Republik Indonesia Nomor 47 Tahun 2013 tentang Statuta Universitas Andalas (Berita Negara Republik Indonesia Tahun 2013 Nomor 596);');\r\n\r\n    }\r\n    // Add more content as needed\r\n\r\n    // Finalize the PDF and close the stream\r\n    doc.end();\r\n\r\n    // Save the SK to database\r\n    if (!pengajuan.SuratKeputusan) {\r\n      await db.SuratKeputusan.create({\r\n        pengajuanId: pengajuanId,\r\n        nomor: '',\r\n        tanggal: new Date(),\r\n        keterangan: '',\r\n        lampiran: '',\r\n        // Add more fields as needed\r\n      });\r\n    }\r\n\r\n    // Send a success response\r\n    res.status(201).send(`SK generated successfully and saved to ${filePath}`);\r\n\r\n  } catch (error) {\r\n    console.error('Error generating SK:', error);\r\n    req.flash('error', 'Failed to generate SK');\r\n    res.redirect('/daftarPengajuan');\r\n  }\r\n};"]}